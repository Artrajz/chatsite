{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>chatsite</title>
</head>
<script src="{% static 'js/jquery.min-3.6.2.js' %}"></script>
<script src="{% static 'js/bootstrap.min.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
<link rel="stylesheet" href="{% static 'css/index.css' %}">

<body>
{% csrf_token %}
<div class="container">
    <div class="live-status">
        {% if username is not None %}
            <span>状态:</span>
            <span style="color: #07c160">在线</span>
            <span>当前用户：</span>
            <span>{{ username }}</span>
        {% else %}
            <span>状态:</span>
            <span style="color: red">离线</span>
        {% endif %}
    </div>
    <div class="form-inline">
        <input type="text" class="form-control" placeholder="请输入群号或用户名" id="talker">
        <input type="button" class="btn btn-default" value="添加好友" id="addTalker_type1">
        <input type="button" class="btn btn-default" value="添加群组" id="addTalker_type2">
        <input type="button" class="btn btn-default" value="创建群组" id="create_group">
        <input type="button" class="btn btn-default" value="连接socket" id="socketConn">
        <input type="button" class="btn btn-default" value="关闭socket" id="closeConn">
        <input type="button" class="btn btn-default" value="登录" id="login">
        <input type="button" class="btn btn-default" value="登出" id="logout">
    </div>
    <div class="user_list">
        <div>好友列表</div>
        {% for i in contactors %}
            <input type="button" class="talker_list btn btn-default" title="{{ i.0 }}" name="1" value="{{ i.1 }}">
        {% endfor %}

        <div>群组列表</div>
        {% for i in groups %}
            <input type="button" class="talker_list btn btn-default" title="{{ i.0 }}" name="2" value="{{ i.1 }}">
        {% endfor %}


    </div>
    <textarea class="message" id="message" readonly></textarea>
    <div><textarea type="text" class="form-control" placeholder="请输入" id="txt" rows="3"></textarea>
        <input type="button" class="btn btn-default" value="发送" id="sendMessage">
    </div>
</div>


</body>
<script>
    var socket;
    var session;
    var talker;
    var talker_type;

    $(document).ready(function () {

        $("#socketConn").click(function () {
            //防止重复连接socket通道,0未连接，1已连接，2正在关闭，3已断开
            if (socket != null && socket.readyState == 1) {
                return;
            }
            session = "{{ session }}";
            socket = new WebSocket("ws://127.0.0.1:8000/channel/" + session + "/")

            //创建好连接之后自动触发
            socket.onopen = function (event) {
                talker = $("#talker").val()
                $("#message").text($("#message").text() + "[连接成功 session:" + session + "]" + "\n")
                $('#message').scrollTop($('#message')[0].scrollHeight);

            }

            //当websocket接收到服务端发来的消息时自动触发这个函数
            socket.onmessage = function (event) {
                let tag = document.createElement("div");
                msg = JSON.parse(event.data);
                $("#message").text($("#message").text() + msg.username + ":" + msg.message + "\n")
                $('#message').scrollTop($('#message')[0].scrollHeight);

            }

            socket.onclose = function (event) {
                $("#message").text($("#message").text() + "[断开连接 session:" + session + "]" + "\n")
                $('#message').scrollTop($('#message')[0].scrollHeight);
            }
        })

        $("#addTalker_type1").click(function (data) {
            let csrftoken = $('[name="csrfmiddlewaretoken"]').val();
            $.ajax({
                url: "/addTalker/",
                type: "POST",
                data: {
                    "csrfmiddlewaretoken": csrftoken,
                    "user_id": "{{ user_id }}",
                    "talker_type": 1,
                    "talker": $("#talker").val(),
                },
                success: function (data) {
                    if (data.success == '200') {
                        alert("添加成功！")
                    } else if (data.success == '201') {
                        alert("添加失败！")
                    } else if (data.success == '202') {
                        alert("不能为空！")
                    } else if (data.success == '203') {
                        alert("已经是好友！")
                    } else if (data.success == '204') {
                        alert("找不到该联系人！")
                    }
                }
            })
        })

        $("#addTalker_type2").click(function () {
            let csrftoken = $('[name="csrfmiddlewaretoken"]').val();
            $.ajax({
                url: "/addTalker/",
                type: "POST",
                data: {
                    "csrfmiddlewaretoken": csrftoken,
                    "user_id": "{{ user_id }}",
                    "talker_type": 2,
                    "talker": $("#talker").val(),
                },
                success: function (data) {
                    if (data.success == '200') {
                        alert("添加成功！")
                    } else if (data.success == '201') {
                        alert("添加失败！")
                    } else if (data.success == '202') {
                        alert("不能为空！")
                    } else if (data.success == '203') {
                        alert("已经在群组里了！")
                    } else if (data.success == '204') {
                        alert("找不到该群组！")
                    }
                }
            })
        })

        $("#create_group").click(function () {
            let csrftoken = $('[name="csrfmiddlewaretoken"]').val();
            $.ajax({
                url: "/create_group/",
                type: "POST",
                data: {
                    "csrfmiddlewaretoken": csrftoken,
                    "group_name": $("#talker").val(),
                },
                success: function (data) {
                    if (data.success == '200') {
                        alert("成功创建群组：" + $("#talker").val())
                    } else if (data.success == '201') {
                        alert("创建失败！")
                    } else if (data.success == '202') {
                        alert("不能为空！")
                    } else if (data.success == '203') {
                        alert("该群组已存在！")
                    }
                }
            })
        })

        $("#sendMessage").click(function () {
            let message = $("#txt").val()
            let json = JSON.stringify({
                "message": message,
                "talker_type":talker_type,
                "talker": talker,
            }).toString();
            socket.send(json);
            $("#txt").val("")
            $("#message").text($("#message").text() + "{{ username }}" + ":" + message + "\n")
            $('#message').scrollTop($('#message')[0].scrollHeight);
        })

        $("#closeConn").click(function () {
            socket.close();
        })

        $("#login").click(function () {
            window.location.href = "/login/"
        })

        $("#logout").click(function () {
            let csrftoken = $('[name="csrfmiddlewaretoken"]').val();
            $.ajax({
                url: "/logout/",
                type: "POST",
                data: {
                    "csrfmiddlewaretoken": csrftoken,
                },
                success: function (data) {
                    if (data.success == '200') {
                        window.location.href = "/index/"
                    }
                }
            })
        })

        $(".talker_list").click(function () {
            talker = $(this).attr("title")
            talker_type = $(this).attr("name")
        })
    })


</script>
</html>